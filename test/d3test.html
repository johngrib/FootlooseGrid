<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Grid 테스트</title>
<link rel="stylesheet" type="text/css" href="../css/footloosegrid.4.css">
<link rel="stylesheet" type="text/css" href="../css/jquery-ui.css">
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="../lib/underscore-min.js"></script>
<script src="../lib/jquery-1.11.3.min.js"></script>
<script src="../lib/jquery-ui.min.js"></script>
<script src="../lib/FileSaver.min.js"></script>
<script src="../lib/jszip.min.js"></script>
<script src="../lib/xlsx.min.js"></script>
<script src="../footloosegrid.4.js"></script>
<script type="text/javascript">

/**
 * tsv 파일을 2차원 array 로 리턴한다
 */
function tsv_to_array (data) {
  return data.split('\n').map((row) => row.split('\t'));
}

/**
 * 문자열이 숫자 형식인지 판별한다
 */
const is_number_str = (() => {
  const reg = /^\s*-?\d+(?:\.\d+)?\s*$/;
  return (str) => reg.test(str);
})();

/**
 * 공백 문자열인지, 길이가 0 인 문자열인지 판별한다
 */
const is_empty_str = (() => {
  const reg = /^\s*$/;
  return (str) => reg.test(str);
})();

/**
 * header label array 와 data array 를 토대로 footloosegrid 의 scheme 을 생성한다
 */
function make_scheme (header, data) {
  
  const labels = _.unzip(header).reduce((before, curr, i) => {

        if(is_empty_str(curr[0])) curr[0] = before[before.length - 1][0];

        before.push(curr);
        return before;
   }, [])
   .map((col) => col.join('||'));
  
  const types = _.unzip(data).map((col) => {
      const sample = col.filter((txt) => (txt != null && !is_empty_str(txt)))[0];
      return is_number_str(sample) ? 'number' : 'str';
  });
  return labels.map((label, i) => ({ name: 'col' + i, type: types[i], width: 90, label, }));
}

/**
 * main
 */
$(document).ready(function(){
  
  const graph = {
      id    : '#graph1',
      $obj  : null,
      $title: $('#graph_title'),
      svg   : null,
      width : null,
      height: 100,
  };
  graph.$obj = $(graph.id);
  
  const grid = {
      $obj  : null,
      cfg   : {
        cols_show         : 15,
        rows_show         : 10,
        fixed_header      : 1,
        use_filter_div    : true,
        use_filter_panel  : true,
        search_by_reg_exp : true,
      },
  }

  const url = 'https://docs.google.com/spreadsheets/d/1CZhnZX_y7ynsSNfDhxNnrp0ObJLQ2_GyDnIL5vR0wrY/pub?gid=425043933&single=true&output=tsv';
  $.ajax(url).done(main_proc);

  function main_proc(result){

    const r_data = tsv_to_array(result);
    const header = r_data.filter((row) => row[0] === 'header');
    const data   = r_data.filter((row) => row[0] !== 'header');
    const scheme = make_scheme(header, data);

    grid.$obj = new footloosegrid('testGrid', grid.cfg, scheme)
        .Create_grid()
        .Load_data(data, undefined, undefined, true);
    
    graph.width = grid.$obj.cfg.left_width + grid.$obj.cfg.right_width_show;

    // graph 생성
    init_graph(null, null, 2, 0, grid.$obj, true);

    // click event 부여
    grid.$obj.attatch_click_event( init_graph );
  }

  // d3 graph 를 초기화한다.
  function init_graph(e, row, col, val, _this, is_init)  {

    if(!_.isNumber(val))
      return;

    if(is_init)
      graph.svg = d3.select(graph.id).append("svg")
                    .attr({width: graph.width, height: graph.height });

    const title   = _this.scheme[col].label.replace('\|\|', ' ');
    const dataset = _.pluck(_this.data, col).reverse();
    const bars    = graph.svg.selectAll("rect").data(dataset)
    const xScale  = d3.scale.ordinal()
                      .domain(d3.range(dataset.length))
                      .rangeRoundBands([0, graph.width], 0.05);
    const yScale  = d3.scale.linear()
                    .domain([d3.min(dataset) - 5, d3.max(dataset)])
                    .range([0, graph.height]);
    graph.$title.text(title);

    if(is_init)
      create_graph(bars, xScale, yScale, col, dataset);
    else
      update_graph(bars, xScale, yScale, col, dataset);

    event_bind_graph(bars, xScale, yScale, col, dataset);
  }
  
  function create_graph(bars, xScale, yScale, col, dataset){
    bars.enter()
     .append("rect")
     .attr({
         index : (d, i) => i,
         x     : (d, i) => xScale(i),
         y     : (d)    => (graph.height - yScale(d)),
         width : xScale.rangeBand(),
         height: (d) => yScale(d),
         column: (d) => col,
         fill  : (d) => ("rgb(0, 0, " + (parseInt(yScale(d),10) * 2) + ")"),
     });
     
    graph.svg.selectAll("text")
     .data(dataset)
     .enter()
     .append("text")
     .text((d) => d)
     .attr({
       x : (d, i) => (xScale(i) + xScale.rangeBand() / 2),
       y : (d)    => (graph.height - yScale(d) + 14),
       'text-anchor': 'middle',
       'font-family': 'sans-serif',
       'font-size'  : '11px',
       'fill'       : 'white',
     });
  }
  
  function update_graph(bars, xScale, yScale, col, dataset) {

    graph.svg.selectAll("text")
       .data(dataset)
       .transition()
       .duration(500)
       .text((d) => d)
       .attr({
         y : (d)    => (graph.height - yScale(d) + 14),
       });
      
    bars.transition()
      .duration(500)
      .attr({
        y     : (d) => (graph.height - yScale(d)),
        height: (d) => yScale(d),
        fill  : (d) => ("rgb(0, 0, " + (parseInt(yScale(d),10) * 2) + ")"),
      });
  }
  
  function event_bind_graph(bars, xScale, yScale, col, dataset) {
   bars
     .on("mouseover", function() { d3.select(this).attr("fill", "orange"); })
     .on("mouseout", function(d) {
        d3.select(this)
          .transition().duration(150) 
          .attr("fill", "rgb(0, 0, " + (parseInt(yScale(d),10) * 2) + ")");
      })
     .on("click", (d) => { console.log(d); });
  }
});

</script>
</head>
<body>
  <div id="graph_title"></div>
  <br>
  <div id="graph1"></div>
  <div id="testGrid"></div>
</body>
</html>